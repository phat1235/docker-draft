**Tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ Device Mapper (ƒë√£ ng·ª´ng h·ªó tr·ª£)**

> **ƒê√£ ng·ª´ng h·ªó tr·ª£**
>
> Tr√¨nh ƒëi·ªÅu khi·ªÉn Device Mapper ƒë√£ [b·ªã ng·ª´ng h·ªó tr·ª£](/manuals/engine/deprecated.md#device-mapper-storage-driver)
> v√† s·∫Ω b·ªã lo·∫°i b·ªè kh·ªèi Docker Engine k·ªÉ t·ª´ phi√™n b·∫£n 25.0. N·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng Device Mapper,
> b·∫°n *ph·∫£i* chuy·ªÉn sang m·ªôt tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ ƒë∆∞·ª£c h·ªó tr·ª£ tr∆∞·ªõc khi n√¢ng c·∫•p l√™n Docker Engine 25.0.
> Xem trang [Docker storage drivers](select-storage-driver.md) ƒë·ªÉ bi·∫øt danh s√°ch c√°c tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ ƒë∆∞·ª£c h·ªó tr·ª£.

Device Mapper l√† m·ªôt khung l√†m vi·ªác (framework) c·∫•p nh√¢n Linux, h·ªó tr·ª£ cho nhi·ªÅu c√¥ng ngh·ªá qu·∫£n l√Ω kh·ªëi l∆∞·ª£ng (volume) ti√™n ti·∫øn.
Tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ `devicemapper` c·ªßa Docker khai th√°c kh·∫£ nƒÉng c·∫•p ph√°t m·ªèng (thin provisioning) v√† snapshot c·ªßa Device Mapper ƒë·ªÉ qu·∫£n l√Ω ·∫£nh (image) v√† container.

Trong t√†i li·ªáu n√†y, ch√∫ng ta s·∫Ω g·ªçi tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ l√† `devicemapper` v√† g·ªçi framework trong nh√¢n l√† *Device Mapper*.

Tr√™n c√°c h·ªá th·ªëng ƒë∆∞·ª£c h·ªó tr·ª£, `devicemapper` ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p trong nh√¢n Linux. Tuy nhi√™n, c·∫ßn c√≥ m·ªôt s·ªë c·∫•u h√¨nh c·ª• th·ªÉ ƒë·ªÉ s·ª≠ d·ª•ng n√≥ v·ªõi Docker.

Tr√¨nh ƒëi·ªÅu khi·ªÉn `devicemapper` ho·∫°t ƒë·ªông ·ªü c·∫•p ƒë·ªô kh·ªëi (block level), s·ª≠ d·ª•ng c√°c thi·∫øt b·ªã kh·ªëi (block devices) d√†nh ri√™ng cho Docker, thay v√¨ ·ªü c·∫•p ƒë·ªô t·ªáp (file level). C√°c thi·∫øt b·ªã n√†y c√≥ th·ªÉ m·ªü r·ªông b·∫±ng c√°ch th√™m b·ªô l∆∞u tr·ªØ v·∫≠t l√Ω v√†o m√°y ch·ªß Docker v√† th∆∞·ªùng cho hi·ªáu su·∫•t t·ªët h∆°n khi so v·ªõi h·ªá th·ªëng t·ªáp truy·ªÅn th·ªëng c·ªßa h·ªá ƒëi·ªÅu h√†nh.

---

## Y√™u c·∫ßu tr∆∞·ªõc khi c·∫•u h√¨nh

* `devicemapper` ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n Docker Engine ‚Äì Community ƒëang ch·∫°y tr√™n CentOS, Fedora, SLES 15, Ubuntu, Debian ho·∫∑c RHEL.
* C·∫ßn c√†i ƒë·∫∑t c√°c g√≥i `lvm2` v√† `device-mapper-persistent-data`.
* Vi·ªác thay ƒë·ªïi tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ s·∫Ω khi·∫øn c√°c container hi·ªán t·∫°i kh√¥ng th·ªÉ truy c·∫≠p ƒë∆∞·ª£c n·ªØa. H√£y d√πng `docker save` ƒë·ªÉ l∆∞u l·∫°i container, v√† ƒë·∫©y ·∫£nh Docker hi·ªán c√≥ l√™n Docker Hub ho·∫∑c repository ri√™ng ƒë·ªÉ tr√°nh ph·∫£i t·∫°o l·∫°i sau n√†y.

---

## C·∫•u h√¨nh Docker s·ª≠ d·ª•ng tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ `devicemapper`

> Tr∆∞·ªõc khi ti·∫øp t·ª•c, b·∫°n c·∫ßn ƒë·∫£m b·∫£o r·∫±ng c√°c y√™u c·∫ßu tr√™n ƒë√£ ƒë∆∞·ª£c ƒë√°p ·ª©ng.

### C·∫•u h√¨nh ch·∫ø ƒë·ªô `loop-lvm` (ch·ªâ d√πng ƒë·ªÉ th·ª≠ nghi·ªám)

Ch·∫ø ƒë·ªô n√†y **ch·ªâ ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng th·ª≠ nghi·ªám**. `loop-lvm` s·ª≠ d·ª•ng c∆° ch·∫ø "loopback", cho ph√©p c√°c t·∫≠p tin tr√™n ƒëƒ©a c·ª©ng ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ c√°c thi·∫øt b·ªã kh·ªëi th·ª±c th·ª•. Tuy nhi√™n, c∆° ch·∫ø n√†y ch·∫≠m v√† ti√™u t·ªën t√†i nguy√™n do ph·∫£i t∆∞∆°ng t√°c th√™m v·ªõi t·∫ßng h·ªá th·ªëng t·ªáp c·ªßa h·ªá ƒëi·ªÅu h√†nh. Ngo√†i ra, n√≥ c√≥ th·ªÉ g√¢y ra ƒëi·ªÅu ki·ªán tranh ch·∫•p (race condition).

Tuy nhi√™n, ch·∫ø ƒë·ªô `loop-lvm` h·ªØu √≠ch ƒë·ªÉ ki·ªÉm tra c∆° b·∫£n (v√≠ d·ª•: thi·∫øu g√≥i ng∆∞·ªùi d√πng, driver nh√¢n, v.v.) tr∆∞·ªõc khi c·∫•u h√¨nh ch·∫ø ƒë·ªô `direct-lvm` ph·ª©c t·∫°p h∆°n.

**Tuy·ªát ƒë·ªëi kh√¥ng s·ª≠ d·ª•ng `loop-lvm` cho h·ªá th·ªëng s·∫£n xu·∫•t**.
Xem ph·∫ßn [C·∫•u h√¨nh ch·∫ø ƒë·ªô direct-lvm cho s·∫£n xu·∫•t](#c·∫•u-h√¨nh-ch·∫ø-ƒë·ªô-direct-lvm-cho-s·∫£n-xu·∫•t).

C√°c b∆∞·ªõc c·∫•u h√¨nh:

1. **D·ª´ng Docker**

   ```bash
   sudo systemctl stop docker
   ```

2. **Ch·ªânh s·ª≠a t·ªáp c·∫•u h√¨nh `/etc/docker/daemon.json`**

   N·∫øu t·ªáp ch∆∞a t·ªìn t·∫°i, b·∫°n c√≥ th·ªÉ t·∫°o m·ªõi. Th√™m n·ªôi dung sau:

   ```json
   {
     "storage-driver": "devicemapper"
   }
   ```

   L∆∞u √Ω: Docker s·∫Ω kh√¥ng kh·ªüi ƒë·ªông n·∫øu t·ªáp JSON b·ªã l·ªói c√∫ ph√°p.

3. **Kh·ªüi ƒë·ªông Docker**

   ```bash
   sudo systemctl start docker
   ```

4. **X√°c minh Docker ƒëang d√πng `devicemapper`**

   ```bash
   docker info
   ```

   N·∫øu b·∫°n th·∫•y:

   * `Storage Driver: devicemapper`
   * `Data loop file: /var/lib/docker/devicemapper/data`
   * `Metadata loop file: /var/lib/docker/devicemapper/metadata`

   ‚Üí H·ªá th·ªëng ƒëang ch·∫°y ·ªü ch·∫ø ƒë·ªô `loop-lvm`.

---

### C·∫•u h√¨nh ch·∫ø ƒë·ªô `direct-lvm` cho h·ªá th·ªëng s·∫£n xu·∫•t

ƒê·ªëi v·ªõi m√¥i tr∆∞·ªùng s·∫£n xu·∫•t, b·∫Øt bu·ªôc ph·∫£i s·ª≠ d·ª•ng `direct-lvm`. Ch·∫ø ƒë·ªô n√†y s·ª≠ d·ª•ng thi·∫øt b·ªã kh·ªëi th·∫≠t ƒë·ªÉ t·∫°o thin pool. ∆Øu ƒëi·ªÉm:

* Nhanh h∆°n loopback
* S·ª≠ d·ª•ng t√†i nguy√™n hi·ªáu qu·∫£ h∆°n
* C√≥ kh·∫£ nƒÉng m·ªü r·ªông khi c·∫ßn

**L∆∞u √Ω quan tr·ªçng**: Vi·ªác thay ƒë·ªïi tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ s·∫Ω khi·∫øn c√°c container c≈© kh√¥ng c√≤n truy c·∫≠p ƒë∆∞·ª£c. H√£y d√πng `docker save` ƒë·ªÉ l∆∞u v√† ƒë·∫©y c√°c ·∫£nh l√™n repository.

#### Cho ph√©p Docker t·ª± c·∫•u h√¨nh ch·∫ø ƒë·ªô `direct-lvm`

Ph√π h·ª£p v·ªõi **c√°c m√°y c√†i m·ªõi Docker** v√† ch·ªâ d√πng **m·ªôt thi·∫øt b·ªã kh·ªëi**. N·∫øu c·∫ßn nhi·ªÅu thi·∫øt b·ªã kh·ªëi ‚Üí [xem c√°ch c·∫•u h√¨nh th·ªß c√¥ng](#c·∫•u-h√¨nh-direct-lvm-th·ªß-c√¥ng).

V√≠ d·ª• c·∫•u h√¨nh trong `/etc/docker/daemon.json`:

```json
{
  "storage-driver": "devicemapper",
  "storage-opts": [
    "dm.directlvm_device=/dev/xdf",
    "dm.thinp_percent=95",
    "dm.thinp_metapercent=1",
    "dm.thinp_autoextend_threshold=80",
    "dm.thinp_autoextend_percent=20",
    "dm.directlvm_device_force=false"
  ]
}
```

Sau ƒë√≥ **kh·ªüi ƒë·ªông l·∫°i Docker** ƒë·ªÉ c·∫•u h√¨nh c√≥ hi·ªáu l·ª±c.

**C·∫£nh b√°o**: Sau khi Docker ƒë√£ chu·∫©n b·ªã thi·∫øt b·ªã, **kh√¥ng n√™n thay ƒë·ªïi c√°c gi√° tr·ªã n√†y**.

---

#### C·∫•u h√¨nh direct-lvm th·ªß c√¥ng

Quy tr√¨nh b√™n d∆∞·ªõi gi·∫£ ƒë·ªãnh b·∫°n c√≥ thi·∫øt b·ªã kh·ªëi `/dev/xvdf` c√≤n tr·ªëng v√† Docker ƒëang ·ªü tr·∫°ng th√°i t·∫Øt.

1. **X√°c ƒë·ªãnh thi·∫øt b·ªã** (v√≠ d·ª• `/dev/xvdf`) c√≥ ƒë·ªß dung l∆∞·ª£ng.

2. **D·ª´ng Docker**

   ```bash
   sudo systemctl stop docker
   ```

3. **C√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt**

   * **CentOS/RHEL**: `device-mapper-persistent-data`, `lvm2`
   * **Ubuntu/Debian/SLES 15**: `thin-provisioning-tools`, `lvm2`

4. **T·∫°o volume v·∫≠t l√Ω (PV)**

   ```bash
   sudo pvcreate /dev/xvdf
   ```

5. **T·∫°o volume group (VG)**

   ```bash
   sudo vgcreate docker /dev/xvdf
   ```

6. **T·∫°o c√°c logical volume (LV)**

   ```bash
   sudo lvcreate --wipesignatures y -n thinpool docker -l 95%VG
   sudo lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG
   ```

7. **Chuy·ªÉn ƒë·ªïi th√†nh thin pool**

   ```bash
   sudo lvconvert -y \
   --zero n \
   -c 512K \
   --thinpool docker/thinpool \
   --poolmetadata docker/thinpoolmeta
   ```

8. **T·∫°o t·ªáp c·∫•u h√¨nh LVM profile**

   ```bash
   sudo vi /etc/lvm/profile/docker-thinpool.profile
   ```

   N·ªôi dung:

   ```text
   activation {
     thin_pool_autoextend_threshold=80
     thin_pool_autoextend_percent=20
   }
   ```

9. **√Åp d·ª•ng profile**

   ```bash
   sudo lvchange --metadataprofile docker-thinpool docker/thinpool
   ```

10. **B·∫≠t gi√°m s√°t t·ª± ƒë·ªông**

```bash
sudo lvchange --monitor y docker/thinpool
```

11. **Di chuy·ªÉn th∆∞ m·ª•c `/var/lib/docker` n·∫øu ƒë√£ t·ªìn t·∫°i**

```bash
sudo su -
mkdir /var/lib/docker.bk
mv /var/lib/docker/* /var/lib/docker.bk
exit
```

12. **Ch·ªânh s·ª≠a `daemon.json`**

```json
{
  "storage-driver": "devicemapper",
  "storage-opts": [
    "dm.thinpooldev=/dev/mapper/docker-thinpool",
    "dm.use_deferred_removal=true",
    "dm.use_deferred_deletion=true"
  ]
}
```

13. **Kh·ªüi ƒë·ªông Docker**

```bash
sudo systemctl start docker
```

14. **Ki·ªÉm tra c·∫•u h√¨nh**

```bash
docker info
```

Ki·ªÉm tra `Storage Driver: devicemapper`, `Pool Name: docker-thinpool`, `Data file:` v√† `Metadata file:` r·ªóng.

15. **X√≥a th∆∞ m·ª•c c·∫•u h√¨nh c≈© n·∫øu m·ªçi th·ª© ho·∫°t ƒë·ªông**

```bash
sudo rm -rf /var/lib/docker.bk
```

---

## Qu·∫£n l√Ω devicemapper

### Gi√°m s√°t thin pool

Kh√¥ng n√™n ch·ªâ ph·ª• thu·ªôc v√†o c∆° ch·∫ø auto-extend. H√£y ch·ªß ƒë·ªông gi√°m s√°t dung l∆∞·ª£ng:

```bash
sudo journalctl -fu dm-event.service
```

C√≥ th·ªÉ ƒë·∫∑t ng∆∞·ª°ng t·ªëi thi·ªÉu kh√¥ng gian tr·ªëng b·∫±ng `dm.min_free_space` trong `daemon.json`. V√≠ d·ª•:

```json
{
  "storage-opts": [
    "dm.min_free_space=10"
  ]
}
```

---

### M·ªü r·ªông dung l∆∞·ª£ng khi ƒëang ch·∫°y

N·∫øu thin pool ƒë·∫ßy, c√≥ th·ªÉ m·ªü r·ªông:

#### V·ªõi loop-lvm

C√°ch d·ªÖ nh·∫•t l√† d√πng ti·ªán √≠ch `device_tool` t·ª´ GitHub:

1. Clone repo:

   ```bash
   git clone https://github.com/moby/moby
   cd moby/contrib/docker-device-tool
   ```

2. Bi√™n d·ªãch theo h∆∞·ªõng d·∫´n trong `README.md`

3. Ch·∫°y:

   ```bash
   ./device_tool resize 200GB
   ```

---

> **K·∫øt lu·∫≠n:** M·∫∑c d√π `devicemapper` ƒë√£ b·ªã lo·∫°i b·ªè kh·ªèi Docker phi√™n b·∫£n m·ªõi, t√†i li·ªáu n√†y v·∫´n h·ªØu √≠ch cho c√°c h·ªá th·ªëng c≈© ho·∫∑c ƒëang c·∫ßn nghi√™n c·ª©u s√¢u v·ªÅ h·ªá th·ªëng l∆∞u tr·ªØ Linux. V·ªõi m√¥i tr∆∞·ªùng s·∫£n xu·∫•t hi·ªán nay, khuy·∫øn ngh·ªã s·ª≠ d·ª•ng overlay2 ho·∫∑c btrfs.


T√†i li·ªáu ƒë√£ ƒë∆∞·ª£c d·ªãch ho√†n ch·ªânh sang ti·∫øng Vi·ªát. D∆∞·ªõi ƒë√¢y l√† b·∫£n d·ªãch ƒë·∫ßy ƒë·ªß:

---

# Tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ `devicemapper` (ƒë√£ ng·ª´ng h·ªó tr·ª£)

> ‚ö†Ô∏è **ƒê√£ ng·ª´ng h·ªó tr·ª£**
>
> Tr√¨nh ƒëi·ªÅu khi·ªÉn Device Mapper ƒë√£ [b·ªã ng·ª´ng h·ªó tr·ª£](https://docs.docker.com/manuals/engine/deprecated/#device-mapper-storage-driver)
> v√† s·∫Ω b·ªã lo·∫°i b·ªè kh·ªèi Docker Engine k·ªÉ t·ª´ phi√™n b·∫£n **25.0**.
> N·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng Device Mapper, b·∫°n **ph·∫£i chuy·ªÉn sang m·ªôt tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ ƒë∆∞·ª£c h·ªó tr·ª£** tr∆∞·ªõc khi n√¢ng c·∫•p l√™n Docker 25.0.
> Xem danh s√°ch c√°c tr√¨nh ƒëi·ªÅu khi·ªÉn ƒë∆∞·ª£c h·ªó tr·ª£ t·∫°i: [Docker storage drivers](https://docs.docker.com/storage/storagedriver/select-storage-driver/)

---

## Gi·ªõi thi·ªáu

**Device Mapper** l√† m·ªôt khung l√†m vi·ªác (framework) c·∫•p nh√¢n Linux h·ªó tr·ª£ nhi·ªÅu c√¥ng ngh·ªá qu·∫£n l√Ω thi·∫øt b·ªã kh·ªëi.
Tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ `devicemapper` c·ªßa Docker t·∫≠n d·ª•ng t√≠nh nƒÉng **thin provisioning** (c·∫•p ph√°t m·ªèng) v√† **snapshot** c·ªßa Device Mapper ƒë·ªÉ qu·∫£n l√Ω **image** v√† **container**.

Tr√¨nh ƒëi·ªÅu khi·ªÉn n√†y ho·∫°t ƒë·ªông ·ªü **c·∫•p ƒë·ªô block** (kh·ªëi d·ªØ li·ªáu), s·ª≠ d·ª•ng c√°c **thi·∫øt b·ªã kh·ªëi chuy√™n bi·ªát** cho Docker, thay v√¨ ho·∫°t ƒë·ªông ·ªü c·∫•p ƒë·ªô t·ªáp nh∆∞ m·ªôt s·ªë tr√¨nh ƒëi·ªÅu khi·ªÉn kh√°c.

---

## Tr·∫°ng th√°i h·ªó tr·ª£

* H·ªá ƒëi·ªÅu h√†nh ƒë∆∞·ª£c h·ªó tr·ª£: **CentOS**, **Fedora**, **SLES 15**, **Ubuntu**, **Debian**, **RHEL**
* G√≥i c·∫ßn thi·∫øt:

  * RHEL/CentOS/Fedora: `lvm2`, `device-mapper-persistent-data`
  * Ubuntu/Debian/SLES: `lvm2`, `thin-provisioning-tools`

> üî• **L∆∞u √Ω**: Thay ƒë·ªïi tr√¨nh ƒëi·ªÅu khi·ªÉn l∆∞u tr·ªØ s·∫Ω khi·∫øn Docker kh√¥ng th·ªÉ truy c·∫≠p ƒë∆∞·ª£c c√°c container c≈©.
> H√£y `docker save` c√°c image v√† backup d·ªØ li·ªáu container tr∆∞·ªõc khi th·ª±c hi·ªán.

---

## 1. Ch·∫ø ƒë·ªô `loop-lvm` (ch·ªâ ƒë·ªÉ th·ª≠ nghi·ªám)

Ch·∫ø ƒë·ªô n√†y **kh√¥ng d√†nh cho s·∫£n xu·∫•t**, v√¨:

* Ch·∫≠m
* D·ªÖ g√¢y l·ªói tranh ch·∫•p (race condition)
* D·ªÖ l√†m ƒë·∫ßy ƒëƒ©a g·ªëc

S·ª≠ d·ª•ng khi b·∫°n mu·ªën **ki·ªÉm tra nhanh** m√† kh√¥ng c·∫•u h√¨nh thi·∫øt b·ªã kh·ªëi th·ªß c√¥ng.

### Thi·∫øt l·∫≠p

1. **D·ª´ng Docker**:

   ```bash
   sudo systemctl stop docker
   ```

2. **T·∫°o `/etc/docker/daemon.json`**:

   ```json
   {
     "storage-driver": "devicemapper"
   }
   ```

3. **Kh·ªüi ƒë·ªông Docker**:

   ```bash
   sudo systemctl start docker
   ```

4. **Ki·ªÉm tra**:

   ```bash
   docker info
   ```

   N·∫øu th·∫•y `Data loop file:`, Docker ƒëang d√πng loopback mode.

---

## 2. Ch·∫ø ƒë·ªô `direct-lvm` (khuy√™n d√πng cho s·∫£n xu·∫•t)

Ch·∫ø ƒë·ªô n√†y s·ª≠ d·ª•ng **thi·∫øt b·ªã kh·ªëi th·∫≠t** (v√≠ d·ª•: `/dev/sdb`) ƒë·ªÉ t·∫°o **thin pool**, gi√∫p:

* Hi·ªáu su·∫•t cao h∆°n
* Kh√¥ng g√¢y race condition
* Qu·∫£n l√Ω m·ªü r·ªông t·ªët h∆°n

C√≥ 2 c√°ch c·∫•u h√¨nh:

### ‚úÖ C√°ch 1: Docker t·ª± c·∫•u h√¨nh `direct-lvm`

1. **Ch·ªânh `daemon.json`**:

   ```json
   {
     "storage-driver": "devicemapper",
     "storage-opts": [
       "dm.directlvm_device=/dev/sdb",
       "dm.thinp_percent=95",
       "dm.thinp_metapercent=1",
       "dm.thinp_autoextend_threshold=80",
       "dm.thinp_autoextend_percent=20",
       "dm.directlvm_device_force=true"
     ]
   }
   ```

2. **Kh·ªüi ƒë·ªông Docker**, n√≥ s·∫Ω t·ª± thi·∫øt l·∫≠p thi·∫øt b·ªã kh·ªëi.

### ‚öôÔ∏è C√°ch 2: C·∫•u h√¨nh `direct-lvm` th·ªß c√¥ng

> Ph√π h·ª£p khi b·∫°n c·∫ßn ki·ªÉm so√°t chi ti·∫øt qu√° tr√¨nh t·∫°o thin pool.

#### C√°c b∆∞·ªõc:

1. **D·ª´ng Docker**:

   ```bash
   sudo systemctl stop docker
   ```

2. **T·∫°o volume group**:

   ```bash
   sudo pvcreate /dev/sdb
   sudo vgcreate docker /dev/sdb
   ```

3. **T·∫°o c√°c LV**:

   ```bash
   sudo lvcreate --wipesignatures y -n thinpool docker -l 95%VG
   sudo lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG
   ```

4. **Chuy·ªÉn sang thin pool**:

   ```bash
   sudo lvconvert -y --zero n -c 512K --thinpool docker/thinpool --poolmetadata docker/thinpoolmeta
   ```

5. **C·∫•u h√¨nh t·ª± ƒë·ªông m·ªü r·ªông**:

   ```bash
   sudo vi /etc/lvm/profile/docker-thinpool.profile
   ```

   N·ªôi dung:

   ```
   activation {
     thin_pool_autoextend_threshold=80
     thin_pool_autoextend_percent=20
   }
   ```

6. **G√°n profile v√† b·∫≠t gi√°m s√°t**:

   ```bash
   sudo lvchange --metadataprofile docker-thinpool docker/thinpool
   sudo lvchange --monitor y docker/thinpool
   ```

7. **X√≥a d·ªØ li·ªáu Docker c≈© (n·∫øu c√≥)**:

   ```bash
   mv /var/lib/docker /var/lib/docker.bk
   mkdir /var/lib/docker
   ```

8. **C·∫•u h√¨nh `daemon.json`**:

   ```json
   {
     "storage-driver": "devicemapper",
     "storage-opts": [
       "dm.thinpooldev=/dev/mapper/docker-thinpool",
       "dm.use_deferred_removal=true",
       "dm.use_deferred_deletion=true"
     ]
   }
   ```

9. **Kh·ªüi ƒë·ªông l·∫°i Docker**:

   ```bash
   sudo systemctl start docker
   ```

10. **X√°c minh**:

    ```bash
    docker info
    ```

    N·∫øu th·∫•y `Storage Driver: devicemapper` v√† `Pool Name: docker-thinpool`, b·∫°n ƒë√£ c·∫•u h√¨nh th√†nh c√¥ng.

---

## 3. Gi√°m s√°t v√† m·ªü r·ªông `thin pool`

* Gi√°m s√°t b·∫±ng journalctl:

  ```bash
  sudo journalctl -fu dm-event.service
  ```

* C√≥ th·ªÉ th√™m t√πy ch·ªçn:

  ```json
  {
    "storage-opts": [
      "dm.min_free_space=10"
    ]
  }
  ```

### M·ªü r·ªông dung l∆∞·ª£ng `loop-lvm` (c√°ch ƒë∆°n gi·∫£n)

1. Clone tool:

   ```bash
   git clone https://github.com/moby/moby
   cd moby/contrib/docker-device-tool
   ```

2. Build v√† ch·∫°y:

   ```bash
   ./device_tool resize 200GB
   ```

---

## T·ªïng k·∫øt

| Lo·∫°i c·∫•u h√¨nh   | Loop-lvm (th·ª≠ nghi·ªám) | Direct-lvm (s·∫£n xu·∫•t) |
| --------------- | --------------------- | --------------------- |
| C·∫•u h√¨nh        | D·ªÖ                    | Kh√≥ h∆°n nh∆∞ng ·ªïn ƒë·ªãnh |
| Hi·ªáu su·∫•t       | Th·∫•p                  | Cao                   |
| An to√†n d·ªØ li·ªáu | Th·∫•p                  | Cao                   |

---

